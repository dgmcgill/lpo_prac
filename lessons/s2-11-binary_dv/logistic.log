-------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/doylewr/lpo_prac/lessons/s2-11-binary_dv/logistic.log
  log type:  text
 opened on:  22 Apr 2021, 08:53:10

. 
. /* PhD Practicum, Spring 2020 */
. /* Regression models for binary data*/
. /* Will Doyle*/
. /* 2021-04-22 */
. 
. clear

. 
. set more off

. 
. set scheme s1color

. 
. graph drop _all

. 
. global ddir "../../data/"

. 
. use ${ddir}attend, clear

. 
. describe

Contains data from ../../data/attend.dta
  obs:        16,289                          
 vars:            28                          11 Apr 2013 10:46
-------------------------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------------------------------
stu_id          long    %12.0f                Student ID
f2evratt        byte    %12.0f     F2EVRATT   Whether has ever attended a postsecondary institution -
                                                composite
sch_id          int     %8.0g                 school id
strat_id        int     %8.0g                 stratum
psu             byte    %8.0g      psu        primary sampling unit
f1sch_id        int     %8.0g                 link to first follow-up school
f1univ1         int     %8.0g      f1univ1    sample member status in by and f1 rounds
f1univ2a        byte    %8.0g      f1univ2a   base year status and how sample member entered f1 sample
f1univ2b        byte    %8.0g      f1univ2b   sample member f1 status
g10cohrt        byte    %8.0g      g10cohrt   sophomore cohort member in 2001-2002 school year
g12cohrt        byte    %8.0g      g12cohrt   f1 senior cohort member
bystuwt         float   %9.0g                 student weight
bysex           byte    %8.0g      bysex      sex-composite
byrace          byte    %8.0g      byrace     student^s race/ethnicity-composite
bydob_p         long    %12.0g                student^s year and month of birth
bypared         byte    %8.0g      bypared    parents^ highest level of education
bymothed        byte    %8.0g      bymothed   mother^s highest level of education-composite
byfathed        byte    %8.0g      byfathed   father^s highest level of education-composite
byincome        byte    %8.0g      byincome   total family income from all sources 2001-composite
byses1          float   %9.0g                 socio-economic status composite, v.1
byses2          float   %9.0g                 socio-economic status composite, v.2
bystexp         byte    %8.0g      bystexp    how far in school student thinks will get-composite
bynels2m        float   %9.0g                 els-nels 1992 scale equated sophomore math score
bynels2r        float   %9.0g                 els-nels 1992 scale equated sophomore reading score
f1qwt           float   %9.0g                 questionnaire weight for f1
f1pnlwt         float   %9.0g                 panel weight, by and f1 (2002 and 2004)
f1psepln        byte    %8.0g      f1psepln   f1 post-secondary plans right after high school
_merge          byte    %23.0g     _merge     
-------------------------------------------------------------------------------------------------------
Sorted by: 

. 
. /* Missing data*/
. 
. foreach myvar of varlist stu_id-f1psepln{ /* Start outer loop */
  2.               foreach i of numlist -3 -4 -8 -9 { /* Start inner loop */
  3.                      replace `myvar'=. if `myvar'== `i'
  4.                                             }  /* End inner loop */
  5.                                           } /* End outer loop */
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(108 real changes made, 108 to missing)
(1,691 real changes made, 1,691 to missing)
(359 real changes made, 359 to missing)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,825 real changes made, 3,825 to missing)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(651 real changes made, 651 to missing)
(171 real changes made, 171 to missing)
(0 real changes made)
(0 real changes made)
(651 real changes made, 651 to missing)
(276 real changes made, 276 to missing)
(0 real changes made)
(0 real changes made)
(651 real changes made, 651 to missing)
(276 real changes made, 276 to missing)
(53 real changes made, 53 to missing)
(0 real changes made)
(651 real changes made, 651 to missing)
(171 real changes made, 171 to missing)
(37 real changes made, 37 to missing)
(0 real changes made)
(651 real changes made, 651 to missing)
(171 real changes made, 171 to missing)
(40 real changes made, 40 to missing)
(0 real changes made)
(651 real changes made, 651 to missing)
(171 real changes made, 171 to missing)
(57 real changes made, 57 to missing)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(651 real changes made, 651 to missing)
(276 real changes made, 276 to missing)
(0 real changes made)
(0 real changes made)
(651 real changes made, 651 to missing)
(276 real changes made, 276 to missing)
(0 real changes made)
(0 real changes made)
(651 real changes made, 651 to missing)
(276 real changes made, 276 to missing)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(276 real changes made, 276 to missing)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(276 real changes made, 276 to missing)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1,164 real changes made, 1,164 to missing)
(785 real changes made, 785 to missing)
(47 real changes made, 47 to missing)

. 
. 
. /* Recodes */
.  
. 
. recode byrace (1=1 "Native American") ///
>                                 (2=2 "Asian/ Pacific Islander") ///
>                                 (3=3 "African-American") ///
>                                 (4/5=4 "Hispanic") ///
>                                 (6=5 "Multiracial") ///                         
>                                 (7=6 "White"), ///
> gen(byrace2) 
(10704 differences between byrace and byrace2)

. 
. recode bysex (1=0 "Non-Female") ///
>                           (2=1 "Female"), ///
>                           gen(female)
(15430 differences between bysex and female)

. 
. 
. /* Set locals */
. 
. local y f2evratt

. 
. local ses byses1

. 
. local demog ib(freq).byrace2 ib(freq).female

. 
. local tests bynels2m bynels2r

. 
. local gtype pdf

. 
. /* Linear Probability Model */
. 
. reg `y' `ses' `demog' `tests'

      Source |       SS           df       MS      Number of obs   =    13,284
-------------+----------------------------------   F(9, 13274)     =    374.14
       Model |  496.008461         9  55.1120512   Prob > F        =    0.0000
    Residual |  1955.28354    13,274  .147301759   R-squared       =    0.2023
-------------+----------------------------------   Adj R-squared   =    0.2018
       Total |  2451.29201    13,283  .184543552   Root MSE        =     .3838

------------------------------------------------------------------------------------------
                f2evratt |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------------------+----------------------------------------------------------------
                  byses1 |   .1230284   .0051494    23.89   0.000     .1129347     .133122
                         |
                 byrace2 |
        Native American  |  -.0799666   .0375121    -2.13   0.033    -.1534955   -.0064376
Asian/ Pacific Islander  |   .1061966   .0118984     8.93   0.000     .0828741    .1295192
       African-American  |   .0664432   .0107626     6.17   0.000     .0453469    .0875395
               Hispanic  |   .0224763    .010479     2.14   0.032     .0019359    .0430167
            Multiracial  |   -.045084   .0158417    -2.85   0.004    -.0761361    -.014032
                         |
                  female |
             Non-Female  |  -.0863008   .0067759   -12.74   0.000    -.0995824   -.0730191
                         |
                bynels2m |   .0069647   .0003931    17.72   0.000     .0061943    .0077352
                bynels2r |   .0047414   .0005583     8.49   0.000      .003647    .0058357
                   _cons |   .3055998   .0154191    19.82   0.000     .2753762    .3358233
------------------------------------------------------------------------------------------

. 
. graph twoway (scatter `y' `ses',jitter(.1)   msize(tiny) ) ///
>                         (lfit `y' `ses' )

. 
. predict e, resid
(3,005 missing values generated)

. 
. // Can always use robust ses
. reg `y' `ses' `demog' `tests', vce(robust)

Linear regression                               Number of obs     =     13,284
                                                F(9, 13274)       =     408.19
                                                Prob > F          =     0.0000
                                                R-squared         =     0.2023
                                                Root MSE          =      .3838

------------------------------------------------------------------------------------------
                         |               Robust
                f2evratt |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------------------+----------------------------------------------------------------
                  byses1 |   .1230284   .0051319    23.97   0.000     .1129691    .1330876
                         |
                 byrace2 |
        Native American  |  -.0799666   .0453305    -1.76   0.078    -.1688208    .0088877
Asian/ Pacific Islander  |   .1061966   .0105472    10.07   0.000     .0855226    .1268707
       African-American  |   .0664432   .0117838     5.64   0.000     .0433454    .0895411
               Hispanic  |   .0224763     .01161     1.94   0.053     -.000281    .0452335
            Multiracial  |   -.045084   .0166198    -2.71   0.007    -.0776612   -.0125069
                         |
                  female |
             Non-Female  |  -.0863008   .0067757   -12.74   0.000    -.0995821   -.0730194
                         |
                bynels2m |   .0069647   .0004003    17.40   0.000       .00618    .0077495
                bynels2r |   .0047414    .000568     8.35   0.000      .003628    .0058547
                   _cons |   .3055998   .0166884    18.31   0.000      .272888    .3383115
------------------------------------------------------------------------------------------

. 
. // Save this for later
. estimates store lpm

. 
. /* Generate predicted probabilites over range of ses*/
. 
. local x byses1

. 
. sum `x', detail

            socio-economic status composite, v.1
-------------------------------------------------------------
      Percentiles      Smallest
 1%        -1.54          -2.11
 5%        -1.18          -2.11
10%         -.95          -1.97       Obs              15,325
25%          -.5          -1.97       Sum of Wgt.      15,325

50%          .04                      Mean           .0426499
                        Largest       Std. Dev.      .7429194
75%          .59            1.8
90%         1.05            1.8       Variance       .5519293
95%         1.26           1.81       Skewness      -.0235649
99%         1.55           1.82       Kurtosis       2.354114

. 
. local no_steps=20

. 
. local mymin=r(min)

. local mymax=r(max)

. local diff=`mymax'-`mymin'

. local step=`diff'/`no_steps'

.     
. margins , predict(xb) ///
>     at((mean) _continuous ///
>         (base) _factor ///
>         `x'=(`mymin'(`step')`mymax') ///          
>        ) ///
>       post

Adjusted predictions                            Number of obs     =     13,284
Model VCE    : Robust

Expression   : Linear prediction, predict(xb)

1._at        : byses1          =       -2.11
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

2._at        : byses1          =     -1.9135
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

3._at        : byses1          =      -1.717
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

4._at        : byses1          =     -1.5205
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

5._at        : byses1          =      -1.324
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

6._at        : byses1          =     -1.1275
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

7._at        : byses1          =   -.9309999
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

8._at        : byses1          =   -.7344999
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

9._at        : byses1          =   -.5379999
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

10._at       : byses1          =   -.3414999
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

11._at       : byses1          =   -.1449999
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

12._at       : byses1          =    .0515001
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

13._at       : byses1          =    .2480001
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

14._at       : byses1          =    .4445001
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

15._at       : byses1          =    .6410001
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

16._at       : byses1          =    .8375001
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

17._at       : byses1          =       1.034
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

18._at       : byses1          =      1.2305
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

19._at       : byses1          =       1.427
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

20._at       : byses1          =      1.6235
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

21._at       : byses1          =        1.82
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         _at |
          1  |   .5106382   .0134564    37.95   0.000     .4842618    .5370146
          2  |   .5348132   .0125359    42.66   0.000      .510241    .5593855
          3  |   .5589883   .0116301    48.06   0.000     .5361917    .5817849
          4  |   .5831634   .0107425    54.29   0.000     .5621065    .6042203
          5  |   .6073385   .0098782    61.48   0.000     .5879758    .6267012
          6  |   .6315135   .0090438    69.83   0.000     .6137865    .6492406
          7  |   .6556886   .0082483    79.49   0.000     .6395208    .6718564
          8  |   .6798637   .0075042    90.60   0.000     .6651544    .6945729
          9  |   .7040388   .0068282   103.11   0.000     .6906544    .7174231
         10  |   .7282138   .0062427   116.65   0.000     .7159773    .7404503
         11  |   .7523889    .005775   130.28   0.000     .7410691    .7637088
         12  |    .776564   .0054557   142.34   0.000     .7658701    .7872579
         13  |    .800739   .0053115   150.76   0.000     .7903278    .8111503
         14  |   .8249141   .0053566   154.00   0.000     .8144144    .8354139
         15  |   .8490892   .0055865   151.99   0.000     .8381389    .8600395
         16  |   .8732643   .0059798   146.04   0.000     .8615431    .8849854
         17  |   .8974393   .0065069   137.92   0.000     .8846848    .9101939
         18  |   .9216144   .0071384   129.11   0.000     .9076221    .9356067
         19  |   .9457895    .007849   120.50   0.000     .9304042    .9611747
         20  |   .9699646   .0086193   112.53   0.000     .9530696    .9868596
         21  |   .9941396   .0094345   105.37   0.000     .9756466    1.012633
------------------------------------------------------------------------------

. 
. // Grab results for plotting    
. 
. marginsplot

  Variables that uniquely identify margins: byses1

. 
. marginsplot, recastci(rarea) ciopts(color(gray%10)) ///
>                         recast(line)  plotopts(color(blue)) ///
>                         xlabel(-2(.3)2) xtitle("SES") ytitle(Linear Prediction) title("") name("LPM")

  Variables that uniquely identify margins: byses1

. 
.                         
. graph export lpm.pdf, replace name("LPM")
(file /Users/doylewr/lpo_prac/lessons/s2-11-binary_dv/lpm.pdf written in PDF format)

. 
. /*Logistic Function*/
. 
. graph drop _all

. 
. local k=.25 /*Scale*/

. local x0=0 /*Location*/

. 
. 
. graph twoway function y=-log(1/x-1) ,range(0 1) xtitle("P") ytitle("Logit(p)")

. 
. 
. /*Logistic Regression */
. 
. // Most general: glm
. glm `y' `ses' `demog' `tests', family(binomial) link(logit) /*Logit model */

Iteration 0:   log likelihood = -5993.9873  
Iteration 1:   log likelihood = -5882.7372  
Iteration 2:   log likelihood = -5881.8941  
Iteration 3:   log likelihood = -5881.8937  

Generalized linear models                         Number of obs   =     13,284
Optimization     : ML                             Residual df     =     13,274
                                                  Scale parameter =          1
Deviance         =  11763.78742                   (1/df) Deviance =   .8862278
Pearson          =  12895.93374                   (1/df) Pearson  =   .9715183

Variance function: V(u) = u*(1-u/1)               [Binomial]
Link function    : g(u) = ln(u/(1-u))             [Logit]

                                                  AIC             =   .8870662
Log likelihood   = -5881.893711                   BIC             =  -114263.8

------------------------------------------------------------------------------------------
                         |                 OIM
                f2evratt |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------------+----------------------------------------------------------------
                  byses1 |   .9044975   .0375964    24.06   0.000     .8308099    .9781851
                         |
                 byrace2 |
        Native American  |  -.2907767   .2208319    -1.32   0.188    -.7235993     .142046
Asian/ Pacific Islander  |   1.024892   .0997533    10.27   0.000     .8293791    1.220405
       African-American  |   .4880563   .0687739     7.10   0.000     .3532619    .6228507
               Hispanic  |   .3010217   .0673856     4.47   0.000     .1689483     .433095
            Multiracial  |   -.290723   .1021569    -2.85   0.004    -.4909468   -.0904992
                         |
                  female |
             Non-Female  |  -.5852037   .0470378   -12.44   0.000    -.6773961   -.4930113
                         |
                bynels2m |   .0461185    .002718    16.97   0.000     .0407913    .0514457
                bynels2r |   .0308627   .0037971     8.13   0.000     .0234205    .0383049
                   _cons |  -1.513998   .1018765   -14.86   0.000    -1.713673   -1.314324
------------------------------------------------------------------------------------------

. 
. // Can also use probit, uses cdf of normal dist    
. glm `y' `ses' `demog' `tests', family(binomial) link(probit) /*Probit Model */

Iteration 0:   log likelihood = -5978.0284  
Iteration 1:   log likelihood =  -5878.115  
Iteration 2:   log likelihood = -5878.0383  
Iteration 3:   log likelihood = -5878.0383  

Generalized linear models                         Number of obs   =     13,284
Optimization     : ML                             Residual df     =     13,274
                                                  Scale parameter =          1
Deviance         =  11756.07668                   (1/df) Deviance =   .8856469
Pearson          =  13406.23809                   (1/df) Pearson  =   1.009962

Variance function: V(u) = u*(1-u/1)               [Binomial]
Link function    : g(u) = invnorm(u)              [Probit]

                                                  AIC             =   .8864857
Log likelihood   = -5878.038342                   BIC             =  -114271.5

------------------------------------------------------------------------------------------
                         |                 OIM
                f2evratt |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------------+----------------------------------------------------------------
                  byses1 |   .5214156   .0212996    24.48   0.000     .4796692    .5631621
                         |
                 byrace2 |
        Native American  |  -.1781082   .1305367    -1.36   0.172    -.4339554     .077739
Asian/ Pacific Islander  |   .5517663   .0544573    10.13   0.000     .4450319    .6585007
       African-American  |   .2699883   .0401898     6.72   0.000     .1912179    .3487588
               Hispanic  |   .1510589   .0391104     3.86   0.000      .074404    .2277139
            Multiracial  |  -.1672064   .0598836    -2.79   0.005    -.2845761   -.0498366
                         |
                  female |
             Non-Female  |   -.337614    .027022   -12.49   0.000    -.3905762   -.2846519
                         |
                bynels2m |   .0264463    .001554    17.02   0.000     .0234004    .0294921
                bynels2r |   .0177605   .0021853     8.13   0.000     .0134773    .0220437
                   _cons |  -.8476451   .0589918   -14.37   0.000    -.9632669   -.7320233
------------------------------------------------------------------------------------------

. 
. // Simpler version of logit model 
. logit `y' `ses' `demog' `tests' 

Iteration 0:   log likelihood = -7383.1405  
Iteration 1:   log likelihood = -5998.4224  
Iteration 2:   log likelihood = -5882.6198  
Iteration 3:   log likelihood = -5881.8938  
Iteration 4:   log likelihood = -5881.8937  

Logistic regression                             Number of obs     =     13,284
                                                LR chi2(9)        =    3002.49
                                                Prob > chi2       =     0.0000
Log likelihood = -5881.8937                     Pseudo R2         =     0.2033

------------------------------------------------------------------------------------------
                f2evratt |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------------+----------------------------------------------------------------
                  byses1 |   .9044976   .0375964    24.06   0.000     .8308101    .9781852
                         |
                 byrace2 |
        Native American  |  -.2907766   .2208319    -1.32   0.188    -.7235993     .142046
Asian/ Pacific Islander  |   1.024893   .0997533    10.27   0.000     .8293798    1.220406
       African-American  |   .4880564   .0687739     7.10   0.000      .353262    .6228508
               Hispanic  |   .3010218   .0673856     4.47   0.000     .1689485    .4330951
            Multiracial  |  -.2907231   .1021569    -2.85   0.004    -.4909469   -.0904993
                         |
                  female |
             Non-Female  |  -.5852038   .0470378   -12.44   0.000    -.6773962   -.4930114
                         |
                bynels2m |   .0461185    .002718    16.97   0.000     .0407913    .0514457
                bynels2r |   .0308627   .0037971     8.13   0.000     .0234205    .0383049
                   _cons |  -1.513998   .1018765   -14.86   0.000    -1.713673   -1.314324
------------------------------------------------------------------------------------------

. 
. est store full_model

. 
. gen mysample=e(sample)

. 
. /* Generating marginal effects */
. 
. 
. estimates restore full_model
(results full_model are active now)

. 
. margins, dydx(*) /*for all coefficients, default is to hold others at mean */

Average marginal effects                        Number of obs     =     13,284
Model VCE    : OIM

Expression   : Pr(f2evratt), predict()
dy/dx w.r.t. : byses1 1.byrace2 2.byrace2 3.byrace2 4.byrace2 5.byrace2 0.female bynels2m bynels2r

------------------------------------------------------------------------------------------
                         |            Delta-method
                         |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------------+----------------------------------------------------------------
                  byses1 |   .1295129   .0050031    25.89   0.000     .1197071    .1393188
                         |
                 byrace2 |
        Native American  |  -.0452716   .0355833    -1.27   0.203    -.1150136    .0244704
Asian/ Pacific Islander  |   .1290152    .010561    12.22   0.000     .1083161    .1497143
       African-American  |   .0677923   .0089834     7.55   0.000     .0501852    .0853993
               Hispanic  |   .0431174   .0093053     4.63   0.000     .0248795    .0613554
            Multiracial  |  -.0452629   .0163784    -2.76   0.006    -.0773641   -.0131618
                         |
                  female |
             Non-Female  |  -.0843727   .0067135   -12.57   0.000     -.097531   -.0712144
                         |
                bynels2m |   .0066036    .000375    17.61   0.000     .0058685    .0073387
                bynels2r |   .0044192   .0005392     8.20   0.000     .0033623     .005476
------------------------------------------------------------------------------------------
Note: dy/dx for factor levels is the discrete change from the base level.

. 
. /*Margins for range of ses */
. 
. estimates restore full_model
(results full_model are active now)

. 
. margins , predict(pr) ///
>     at((mean) _continuous ///
>         (base) _factor ///
>         `x'=(`mymin'(`step')`mymax') ///          
>        ) ///
>       post

Adjusted predictions                            Number of obs     =     13,284
Model VCE    : OIM

Expression   : Pr(f2evratt), predict(pr)

1._at        : byses1          =       -2.11
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

2._at        : byses1          =     -1.9135
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

3._at        : byses1          =      -1.717
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

4._at        : byses1          =     -1.5205
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

5._at        : byses1          =      -1.324
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

6._at        : byses1          =     -1.1275
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

7._at        : byses1          =   -.9309999
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

8._at        : byses1          =   -.7344999
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

9._at        : byses1          =   -.5379999
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

10._at       : byses1          =   -.3414999
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

11._at       : byses1          =   -.1449999
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

12._at       : byses1          =    .0515001
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

13._at       : byses1          =    .2480001
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

14._at       : byses1          =    .4445001
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

15._at       : byses1          =    .6410001
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

16._at       : byses1          =    .8375001
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

17._at       : byses1          =       1.034
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

18._at       : byses1          =      1.2305
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

19._at       : byses1          =       1.427
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

20._at       : byses1          =      1.6235
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

21._at       : byses1          =        1.82
               byrace2         =           6
               female          =           1
               bynels2m        =     46.1288 (mean)
               bynels2r        =    30.23475 (mean)

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         _at |
          1  |   .4104825   .0208968    19.64   0.000     .3695255    .4514395
          2  |   .4540705   .0198075    22.92   0.000     .4152485    .4928925
          3  |   .4983741   .0184073    27.07   0.000     .4622966    .5344517
          4  |   .5427033   .0167719    32.36   0.000     .5098309    .5755756
          5  |   .5863664   .0149946    39.11   0.000     .5569774    .6157553
          6  |   .6287126   .0131765    47.71   0.000     .6028872     .654538
          7  |   .6691696   .0114167    58.61   0.000     .6467933    .6915458
          8  |   .7072707    .009803    72.15   0.000     .6880572    .7264843
          9  |   .7426713   .0084034    88.38   0.000      .726201    .7591416
         10  |   .7751517   .0072582   106.80   0.000      .760926    .7893775
         11  |    .804611   .0063745   126.22   0.000     .7921172    .8171049
         12  |   .8310519   .0057259   145.14   0.000     .8198293    .8422745
         13  |   .8545614   .0052603   162.45   0.000     .8442514    .8648714
         14  |   .8752904   .0049166   178.03   0.000     .8656542    .8849267
         15  |   .8934334   .0046402   192.54   0.000     .8843389     .902528
         16  |   .9092107    .004392   207.02   0.000     .9006026    .9178188
         17  |   .9228539   .0041487   222.44   0.000     .9147226    .9309852
         18  |   .9345943   .0038996   239.66   0.000     .9269513    .9422374
         19  |   .9446552   .0036421   259.37   0.000     .9375169    .9517935
         20  |   .9532459   .0033781   282.18   0.000     .9466249    .9598669
         21  |   .9605588   .0031118   308.68   0.000     .9544597    .9666579
------------------------------------------------------------------------------

.           
. //Marginsplot
. 
. 
. marginsplot, recastci(rarea) ciopts(color(gray%10)) ///
>                         recast(line)  plotopts(color(blue)) ///
> xlabel(-2(.3)2) xtitle("SES") ytitle(Linear Prediction) title("") name("logit_basic")

  Variables that uniquely identify margins: byses1

. 
. 
.                         
. graph export logit_basic.pdf, replace name("logit_basic")
(file /Users/doylewr/lpo_prac/lessons/s2-11-binary_dv/logit_basic.pdf written in PDF format)

. 
.     
. /* Margins for range of ses, all races */
. 
. estimates restore full_model
(results full_model are active now)

. 
. quietly margins , predict(pr) ///
>     at((mean) _continuous ///
>         (base) _factor ///
>         `x'=(`mymin'(`step')`mymax') ///
>         byrace2=(1(1)6) ///
>        ) ///
>       post

. 
. 
. marginsplot, recastci(rarea) ciopts(color(%10)) ///
>                                 recast(line) ///
>               xlabel(-2(.3)2) xtitle("SES") ytitle("Pr(Attend)") title("") ///
>               name("logit_race")

  Variables that uniquely identify margins: byses1 byrace2

. 
.                         
. graph export logit_race.pdf, replace name("logit_race")
(file /Users/doylewr/lpo_prac/lessons/s2-11-binary_dv/logit_race.pdf written in PDF format)

.         
. estimates restore full_model                    
(results full_model are active now)

. 
. quietly margins , predict(pr) ///
>     at((mean) _continuous ///
>         (base) _factor ///
>         `x'=(`mymin'(`step')`mymax') ///
>         byrace2=(3 4 6) ///
>        ) ///
>       post

. 
. 
. marginsplot, recastci(rarea) ciopts(color(%10)) ///
>                                 recast(line) ///
>                                 xlabel(-2(.3)2) xtitle("SES") ytitle(Linear Prediction) title("") ///
>                                 legend(cols(1))

  Variables that uniquely identify margins: byses1 byrace2

. 
.                                 
. // Another option
. 
. estimates restore full_model
(results full_model are active now)

. 
. marginscontplot2 byses1, at1(-2(.2)2) ci                                

. 
. mcp2 byses1, at1(-2(.1)2) ci

. 
. mcp2 byses1 byrace2, at1(-2(.1)2) ci                            

. 
. // Other functions
. 
. estimates restore full_model
(results full_model are active now)

. 
. 
. // What are odds ratios (Q:would we ever care A:NO)?
. 
. mean f2evratt,over(female)

Mean estimation                        Number of obs   =     13,359

-------------------------------------------------------------------
                  |       Mean   Std. Err.     [95% Conf. Interval]
------------------+------------------------------------------------
c.f2evratt@female |
      Non-Female  |   .7157305   .0056269       .704701      .72676
          Female  |   .7888055   .0049026      .7791957    .7984154
-------------------------------------------------------------------

. 
. mat results=e(b)

. 
. scalar attend_not_female=results[1,1]

. 
. scalar not_attend_not_female=1-attend_not_female

. 
. scalar odds_not_female=attend_not_female/not_attend_not_female

. 
. scalar attend_female=results[1,2]

. 
. scalar not_attend_female=1-attend_female

. 
. scalar odds_female=attend_female/not_attend_female

. 
. scalar li odds_not_female odds_female
odds_not_female =  2.5177887
odds_female =  3.7349727

. 
. scalar or_female=odds_female/odds_not_female

. 
. scalar li or_female
 or_female =  1.4834337

. 
. logistic f2evratt female

Logistic regression                             Number of obs     =     13,359
                                                LR chi2(1)        =      95.95
                                                Prob > chi2       =     0.0000
Log likelihood = -7410.2256                     Pseudo R2         =     0.0064

------------------------------------------------------------------------------
    f2evratt | Odds Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      female |   1.483434   .0599035     9.77   0.000     1.370551    1.605614
       _cons |   2.517789   .0696266    33.39   0.000     2.384955     2.65802
------------------------------------------------------------------------------
Note: _cons estimates baseline odds.

. 
. /* QE: or for parent with a bachelor's degree */
. 
. 
. listcoef /*Display odds ratios from model in memory */

logistic (N=13359): Factor Change in Odds 

  Odds of: Yes vs No

------------------------------------------------------------------
f2evratt |      b         z     P>|z|    e^b    e^bStdX      SDofX
---------+--------------------------------------------------------
  female |   0.39436    9.766   0.000   1.4834   1.2178     0.4997
------------------------------------------------------------------

. 
. logistic `y' `ses' `demog' `tests'  /*Works too */

Logistic regression                             Number of obs     =     13,284
                                                LR chi2(9)        =    3002.49
                                                Prob > chi2       =     0.0000
Log likelihood = -5881.8937                     Pseudo R2         =     0.2033

------------------------------------------------------------------------------------------
                f2evratt | Odds Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------------+----------------------------------------------------------------
                  byses1 |    2.47069   .0928891    24.06   0.000     2.295177    2.659625
                         |
                 byrace2 |
        Native American  |   .7476827   .1651122    -1.32   0.188     .4850034     1.15263
Asian/ Pacific Islander  |   2.786797   .2779922    10.27   0.000     2.291897    3.388562
       African-American  |   1.629147   .1120428     7.10   0.000     1.423704    1.864235
               Hispanic  |   1.351239    .091054     4.47   0.000     1.184059    1.542023
            Multiracial  |   .7477227    .076385    -2.85   0.004     .6120466     .913475
                         |
                  female |
             Non-Female  |   .5569923   .0261997   -12.44   0.000     .5079378    .6107843
                         |
                bynels2m |   1.047198   .0028463    16.97   0.000     1.041635    1.052792
                bynels2r |   1.031344   .0039161     8.13   0.000     1.023697    1.039048
                   _cons |   .2200284   .0224157   -14.86   0.000     .1802027    .2686558
------------------------------------------------------------------------------------------
Note: _cons estimates baseline odds.

.  
. /* Measures of model fit: all imperfect */
. 
. // Built in methods
. 
. estimates restore full_model
(results full_model are active now)

. 
. fitstat

Measures of Fit for logit of f2evratt

Log-Lik Intercept Only:    -7383.141     Log-Lik Full Model:        -5881.894
D(13272):                  11763.787     LR(9):                      3002.494
                                         Prob > LR:                     0.000
McFadden's R2:                 0.203     McFadden's Adj R2:             0.202
Maximum Likelihood R2:         1.000     Cragg & Uhler's R2:            1.000
McKelvey and Zavoina's R2:     0.350     Efron's R2:                    0.219
Variance of y*:                5.060     Variance of error:             3.290
Count R2:                      0.790     Adj Count R2:                  0.141
AIC:                           0.887     AIC*n:                     11787.787
BIC:                     -114244.769     BIC':                      -2917.045

. 
. /* Likelihood ratio test for nested models */
. quietly logit `y' `ses' if mysample==1

. 
. est store ses

. 
. lrtest full_model ses

Likelihood-ratio test                                 LR chi2(8)  =   1398.05
(Assumption: ses nested in full_model)                Prob > chi2 =    0.0000

. 
. quietly logit `y'  `demog' if mysample==1

. 
. est store demog

. 
. lrtest full_model demog

Likelihood-ratio test                                 LR chi2(3)  =   2542.87
(Assumption: demog nested in full_model)              Prob > chi2 =    0.0000

. 
. quietly logit `y' `tests' if mysample==1

. 
. est store tests

. 
. lrtest full_model tests

Likelihood-ratio test                                 LR chi2(7)  =    860.54
(Assumption: tests nested in full_model)              Prob > chi2 =    0.0000

. 
. estimates restore full_model
(results full_model are active now)

. 
. /* Percent Correctly Predicted  */
. 
. estat classification

Logistic model for f2evratt

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |      9322          2068  |      11390
     -     |       719          1175  |       1894
-----------+--------------------------+-----------
   Total   |     10041          3243  |      13284

Classified + if predicted Pr(D) >= .5
True D defined as f2evratt != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   92.84%
Specificity                     Pr( -|~D)   36.23%
Positive predictive value       Pr( D| +)   81.84%
Negative predictive value       Pr(~D| -)   62.04%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   63.77%
False - rate for true D         Pr( -| D)    7.16%
False + rate for classified +   Pr(~D| +)   18.16%
False - rate for classified -   Pr( D| -)   37.96%
--------------------------------------------------
Correctly classified                        79.02%
--------------------------------------------------

. 
. // Sensitivity/Specificity trafeoff
. 
. estimates restore full_model
(results full_model are active now)

. 
. lsens, genprob(pr) genspec(spec) gensens(sens) replace

. 
. browse pr spec sens

. 
. /*Area under Receiver/Operator Characteristic Curve */
. 
. lroc, name("lroc1")

Logistic model for f2evratt

number of observations =    13284
area under ROC curve   =   0.8013

. 
. /*comparing two models */
. 
. est restore ses
(results ses are active now)

. 
. predict xb_ses, xb
(964 missing values generated)

. 
. est restore full_model
(results full_model are active now)

. 
. predict xb_full, xb
(964 missing values generated)

.  
. roccomp f2evratt xb_full xb_ses, graph summary name("roc2")

                              ROC                    -Asymptotic Normal--
                   Obs       Area     Std. Err.      [95% Conf. Interval]
-------------------------------------------------------------------------
xb_full         13,284     0.8013       0.0043        0.79293     0.80960
xb_ses          13,284     0.7300       0.0048        0.72056     0.73934
-------------------------------------------------------------------------
Ho: area(xb_full) = area(xb_ses)
    chi2(1) =   345.06       Prob>chi2 =   0.0000

. 
. graph export roc_curve.pdf , replace name("roc2")  ///
> 
(file /Users/doylewr/lpo_prac/lessons/s2-11-binary_dv/roc_curve.pdf written in PDF format)

. exit

end of do-file


